<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Monitor Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <nav class="nav">
        <button class="nav-btn active" data-page="dashboard">Dashboard</button>
        <button class="nav-btn" data-page="settings">Settings</button>
    </nav>

    <div id="dashboard" class="page active">
        <div class="card">
            <h2>Input / Output Status</h2>
            <div id="io-status-dash"></div>
        </div>
        <div class="card">
            <h2>Motor Control</h2>
            <div class="motor-visual">
                <div class="motor-speed-display">
                    <span id="motor-speed-big">50</span><span class="unit">m/s</span>
                </div>
                <div class="motor-circle stopped" id="motor-circle" title="Motor status"></div>
                <div class="motor-circle-label" id="motor-label">Stopped</div>
            </div>
            <div class="motor-row">
                <button class="btn btn-primary" id="btn-start">Start</button>
                <button class="btn btn-danger" id="btn-stop">Stop</button>
            </div>
            <div class="slider-wrap">
                <label>Speed:</label>
                <input type="range" id="speed-slider" min="0" max="100" value="50">
                <span class="speed-val" id="speed-display">0</span>m/s
                <button class="btn btn-primary" id="btn-confirm-speed">Confirm</button>
            </div>
            <div class="dir-row">
                <button class="btn btn-warn" id="btn-forward">Forward</button>
                <button class="btn btn-warn" id="btn-backward">Backward</button>
                <p class="warn-msg" id="dir-warn">Stop the motor before switching direction.</p>
            </div>
        </div>
        <div class="card">
            <h2>Timer Display</h2>
            <div class="status-row" style="margin-bottom:8px">
                <span id="current-time">--:--:--</span>
            </div>
            <div class="timer-grid" id="timer-dash"></div>
        </div>
    </div>

    <div id="settings" class="page">
        <div class="card">
            <h2>Input / Output Settings</h2>
            <div class="toggle-row">
                <label>Inputs Master:</label>
                <div class="switch" id="input-master" data-on="0"></div>
            </div>
            <div class="toggle-row">
                <label>Outputs Master:</label>
                <div class="switch" id="output-master" data-on="0"></div>
            </div>
            <div id="io-settings"></div>
        </div>
        <div class="card timer-settings">
            <h2>Timers (4)</h2>
            <div id="timer-settings"></div>
        </div>
        <div class="card">
            <h2>WiFi Configuration</h2>
            <div class="wifi-row">
                <label for="wifi-ssid">SSID</label>
                <input id="wifi-ssid" class="text-input" type="text" autocomplete="off">
            </div>
            <div class="wifi-row">
                <label for="wifi-password">Password</label>
                <input id="wifi-password" class="text-input" type="password" autocomplete="off">
            </div>
            <div class="wifi-row">
                <label for="wifi-ip">Device IP</label>
                <input id="wifi-ip" class="text-input" type="text" autocomplete="off">
            </div>
            <button class="btn btn-primary" id="wifi-save">Save WiFi</button>
            <p class="wifi-note" id="wifi-status">WiFi settings are stored only in this browser.</p>
        </div>
    </div>

    <script>
    (function(){
        const STORAGE = 'monitor_state';
        const socket = io(); // Connect to server via WebSockets

        function load() {
            try { return JSON.parse(localStorage.getItem(STORAGE) || '{}') } catch(e) { return {} }
        }
        function save(o) { localStorage.setItem(STORAGE, JSON.stringify(o)) }

        let state = load();

        // Initialize state structure if empty
        if(!state.io){state.io={inputMaster:0,outputMaster:0,inputs:[{on:0,timer:0,onSince:0},{on:0,timer:0,onSince:0},{on:0,timer:0,onSince:0},{on:0,timer:0,onSince:0}],outputs:[{on:0,timer:0},{on:0,timer:0},{on:0,timer:0},{on:0,timer:0}]}}
        state.io.inputs.forEach(function(inp){if(inp.onSince===undefined)inp.onSince=0;});
        state.io.outputs.forEach(function(out){if(out.timer===undefined)out.timer=0;});
        if(!state.motor){state.motor={running:0,speed:50,speedPending:50,direction:'forward'}}
        if(!state.timers){state.timers=[{enabled:0,start:'08:00',end:'12:00',outputs:[]},{enabled:0,start:'12:00',end:'18:00',outputs:[]},{enabled:0,start:'18:00',end:'22:00',outputs:[]},{enabled:0,start:'22:00',end:'23:59',outputs:[]}]}
        state.timers.forEach(function(t){if(!t.outputs)t.outputs=[];});
        if(!state.network){state.network={ssid:'',password:'',ip:''}};

        function persist() { save(state) }

        // --- Socket.io Handlers ---
        socket.on('config_update', (data) => {
            console.log('MQTT Config Received:', data);
            if (data.speed !== undefined) state.motor.speed = data.speed;
            if (data.running !== undefined) state.motor.running = data.running;
            if (data.direction) state.motor.direction = data.direction;
            persist();
            renderMotor();
        });

        socket.on('status_update', (data) => {
            console.log('MQTT Status Received:', data);
            if (data.inputs) state.io.inputs = data.inputs;
            renderIODash();
        });

        // --- Navigation ---
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.page).classList.add('active');
            };
        });

        function formatRunTime(ms) {
            if(!ms || ms <= 0) return '0:00';
            var s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60);
            s %= 60; m %= 60;
            return (h ? h + ':' : '') + (m < 10 && h ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
        }

        // --- Rendering Logic ---
        function renderIODash() {
            const el = document.getElementById('io-status-dash');
            const io = state.io;
            const now = Date.now();
            let html = '';
            const inputLabels = ['Input1','Input2','Input3','Input4'];
            const outputLabels = ['Output1','Output2','Output3','Output4'];
            const inputs = io.inputMaster ? io.inputs : io.inputs.map(() => ({on:0,onSince:0}));
            
            inputs.forEach((inp, i) => {
                const runStr = inp.on && inp.onSince ? formatRunTime(now - inp.onSince) : '';
                html += `<div class="status-row"><span class="dot ${inp.on?'on':'off'}"></span><span>${inputLabels[i]}: ${inp.on?'ON':'OFF'}</span>${runStr?`<span class="io-run-time">Running: ${runStr}</span>`:''}</div>`;
            });
            const outputs = io.outputMaster ? io.outputs : io.outputs.map(() => ({on:0}));
            outputs.forEach((out, i) => {
                html += `<div class="status-row"><span class="dot ${out.on?'on':'off'}"></span><span>${outputLabels[i]}: ${out.on?'ON':'OFF'}</span></div>`;
            });
            el.innerHTML = html;
        }

        function renderMotor() {
            const m = state.motor;
            const circle = document.getElementById('motor-circle');
            const label = document.getElementById('motor-label');
            circle.className = 'motor-circle ' + (m.running ? 'running' : 'stopped');
            label.textContent = m.running ? 'Running' : 'Stopped';
            document.getElementById('motor-speed-big').textContent = m.speed;
            document.getElementById('speed-slider').value = m.speedPending;
            document.getElementById('speed-display').textContent = m.speed;
            
            ['forward', 'backward'].forEach(dir => {
                const btn = document.getElementById(`btn-${dir}`);
                btn.style.background = m.direction === dir ? '#0d7377' : '#2d3139';
                btn.style.color = m.direction === dir ? '#fff' : '#e4e6eb';
            });
        }

        // --- Motor Control Events ---
        document.getElementById('speed-slider').oninput = function() {
            state.motor.speedPending = +this.value;
            document.getElementById('speed-display').textContent = this.value;
        };
        document.getElementById('btn-confirm-speed').onclick = function() {
            state.motor.speed = state.motor.speedPending;
            renderMotor();
            persist();
        };
        document.getElementById('btn-start').onclick = function() { state.motor.running = 1; renderMotor(); persist(); };
        document.getElementById('btn-stop').onclick = function() { state.motor.running = 0; renderMotor(); persist(); };
        
        document.getElementById('btn-forward').onclick = () => setDirection('forward');
        document.getElementById('btn-backward').onclick = () => setDirection('backward');

        function setDirection(dir) {
            if(state.motor.running) { document.getElementById('dir-warn').classList.add('show'); return; }
            document.getElementById('dir-warn').classList.remove('show');
            state.motor.direction = dir;
            renderMotor();
            persist();
        }

        // --- Settings Rendering ---
        function renderIOSettings() {
            const el = document.getElementById('io-settings');
            let html = '<div class="io-grid">';
            ['Input1','Input2','Input3','Input4'].forEach((l,i)=>{
                const item = state.io.inputs[i] || {on:0};
                html += `<div class="io-item"><label>${l}</label><div class="switch ${item.on?'on':''}" data-type="input" data-i="${i}"></div></div>`;
            });
            ['Output1','Output2','Output3','Output4'].forEach((l,i)=>{
                const item = state.io.outputs[i] || {on:0,timer:0};
                html += `<div class="io-item"><label>${l}</label><div class="switch ${item.on?'on':''}" data-type="output" data-i="${i}"></div><button class="btn timer-btn" data-i="${i}" style="background:${item.timer?'#0d7377':''}; color:${item.timer?'#fff':''}">Timer</button></div>`;
            });
            el.innerHTML = html + '</div>';
            
            el.querySelectorAll('.switch').forEach(sw => {
                sw.onclick = function() {
                    const type = this.dataset.type;
                    const i = +this.dataset.i;
                    if(type === 'input' && !state.io.inputMaster) return;
                    if(type === 'output' && (!state.io.outputMaster || state.io.outputs[i].timer)) return;
                    
                    const obj = type === 'input' ? state.io.inputs[i] : state.io.outputs[i];
                    obj.on = obj.on ? 0 : 1;
                    if(type === 'input') obj.onSince = obj.on ? Date.now() : 0;
                    
                    persist();
                    renderIOSettings();
                    renderIODash();
                };
            });

            el.querySelectorAll('.timer-btn').forEach(btn => {
                btn.onclick = function() {
                    const i = +this.dataset.i;
                    state.io.outputs[i].timer = state.io.outputs[i].timer ? 0 : 1;
                    persist();
                    renderIOSettings();
                };
            });
        }

        // --- Timers & Clock ---
        function applyTimers() {
            const now = new Date();
            const min = now.getHours() * 60 + now.getMinutes();
            let activeOutputs = new Set();

            state.timers.forEach(t => {
                if(!t.enabled || !t.outputs.length) return;
                const startM = timeToMinutes(t.start);
                const endM = timeToMinutes(t.end);
                const isActive = startM <= endM ? (min >= startM && min < endM) : (min >= startM || min < endM);
                if(isActive) t.outputs.forEach(o => activeOutputs.add(o));
            });

            state.io.outputs.forEach((out, i) => {
                if(out.timer) out.on = activeOutputs.has(i) ? 1 : 0;
            });
        }

        function timeToMinutes(str) {
            const p = str.split(':');
            return (parseInt(p[0], 10) || 0) * 60 + (parseInt(p[1], 10) || 0);
        }

        function updateTime() {
            const el = document.getElementById('current-time');
            if(el) el.textContent = new Date().toLocaleTimeString();
            applyTimers();
            renderIODash();
        }

        // Initialization
        setInterval(updateTime, 1000);
        renderMotor();
        renderIOSettings();
        renderIODash();
    })();
    </script>
</body>
</html>